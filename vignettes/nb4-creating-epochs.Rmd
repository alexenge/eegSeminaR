---
title: "4. Creating epochs"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{4. Creating epochs}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor: visual
editor_options:
  chunk_output_type: inline
---

> 🎯 **GOALS**
>
> -   *Learn how to load EEG data into R*
> -   *Visually inspect the raw EEG signal*
> -   *Understand the basics of frequency-domain filtering*

## 4.1 Read raw data

```{r, message=FALSE}
library(here)
library(eegUtils)
```

```{r}
bids_dir <- here("data", "n170")
deriv_dir <- here(bids_dir, "derivatives", "eegUtils", "sub-001", "eeg")
preproc_file <- here(deriv_dir, "sub-001_task-N170_desc-preprocessed_eeg.rds")
dat_filt <- readRDS(preproc_file)
```

## 4.2 Event codes

```{r, eval=FALSE}
events_file <- here(bids_dir, "task-N170_events.json")
file.edit(events_file)
```

```{r}
event_codes <- c(1:80)
epoch_labels <- ifelse(event_codes <= 40, "face", "car")
```

> ✍️ **EXERCISE 4.2**
>
> *Can you come up with a different way to construct the `epoch_labels` vector? Here's a tip if you get stuck.*[^1]

```{r, eval=FALSE}
...
```

[^1]: One way would be to *repeat* (check `?rep`) each value (`"face"` and `"car"`) 40 times and then combining them into one vector.

## 4.3 Construct epochs

```{r}
dat_epo <- epoch_data(
  dat_filt,
  event_codes,
  time_lim = c(-0.2, 0.8),
  epoch_labels = epoch_labels
)
```

> ✍️ **EXERCISE 4.3**
>
> *Check the `epochs` and `timings` tables of the new object. Compare them to the ones from the continuous (clean) data.*

```{r, eval=FALSE}
...
```

```{r}
erp_image(dat_epo, electrode = "PO4")
```

## 4.4 Baseline correction

```{r}
dat_basl <- rm_baseline(dat_epo, c(-0.2, 0.0))
erp_image(dat_basl, electrode = "PO4")
```

> ✍️ **EXERCISE 4.?**
>
> *Confirm that the average voltage during the baseline window is actually zero for a single epoch and channel. One approach to do this: Take the baselined epochs and (1) get the relevant indices (one epoch, all baseline time points) from the `timings` table, (2) Extract one channel (column) from the `signals` table and index it by the index vector, and (3) compute the mean over these signals.*

```{r, eval=FALSE}
baseline_ixs <- with(dat_basl$timings, epoch == ... & time < 0.0)
baseline_signals <- ...
...(baseline_signals)
```

-   Let's save the baseline-corrected epochs so we can re-use them in the next notebook:

```{r}
epoch_file <- here(deriv_dir, "sub-001_task-N170_desc-epoched_eeg.rds")
saveRDS(dat_basl, epoch_file)
```
